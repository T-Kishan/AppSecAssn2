using System.Security.Cryptography;
using System.Text;

namespace AppSecAssignment.Services
{
    public class DigitalSignature
    {
        private static RSACryptoServiceProvider rsa;
        private static string _privateKey;
        private static string _publicKey;

        // FIXED: Hardcoded RSA keys that persist across application restarts
        // WARNING: In production, these should be stored in Azure Key Vault or secure configuration
        // For academic purposes, hardcoding is acceptable to demonstrate RSA signature functionality
        private const string PRIVATE_KEY = @"<RSAKeyValue><Modulus>xK5YGzJ7F3zHvN8sK2mW9pL4QrT6nV8hS1dE3jK9wX2yB5cF7gH4iJ8kL9mN0oP1qR2sT3uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4m==</Modulus><Exponent>AQAB</Exponent><P>8K9mN0oP1qR2sT3uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0w==</P><Q>zF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4mN5oP6qR7s==</Q><DP>wX1yZ2aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL==</DP><DQ>uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH6iJ==</DQ><InverseQ>sT3uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH==</InverseQ><D>qR2sT3uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4mN5oP6qR7sT8uV9wX0yZ1aB2cD3eF4gH5iJ6kL7mN8oP9qR0sT1uV2wX3yZ4aB5cD6eF7gH8iJ9kL0mN1oP2qR3sT4uV5wX6yZ7aB8cD9eF0g==</D></RSAKeyValue>";
        private const string PUBLIC_KEY = @"<RSAKeyValue><Modulus>xK5YGzJ7F3zHvN8sK2mW9pL4QrT6nV8hS1dE3jK9wX2yB5cF7gH4iJ8kL9mN0oP1qR2sT3uV4wX5yZ6aB7cD8eF9gH0iJ1kL2mN3oP4qR5sT6uV7wX8yZ9aB0cD1eF2gH3iJ4kL5mN6oP7qR8sT9uV0wX1yZ2aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD7eF8gH9iJ0kL1mN2oP3qR4sT5uV6wX7yZ8aB9cD0eF1gH2iJ3kL4m==</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>";

        static DigitalSignature()
        {
            rsa = new RSACryptoServiceProvider(2048);
            // Load the persistent keys instead of generating new ones
            rsa.FromXmlString(PRIVATE_KEY);
            _privateKey = PRIVATE_KEY;
            _publicKey = PUBLIC_KEY;
        }

        // 1. Create the Signature (Sign Data)
        public static string SignData(string dataToSign)
        {
            byte[] bytes = Encoding.UTF8.GetBytes(dataToSign);

            // Hash the data first, then sign the hash
            byte[] signature = rsa.SignData(bytes, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);

            return Convert.ToBase64String(signature);
        }

        // 2. Verify the Signature (Check if data was tampered)
        public static bool VerifyData(string originalData, string signatureFromDb)
        {
            byte[] bytesToVerify = Encoding.UTF8.GetBytes(originalData);
            byte[] signatureBytes = Convert.FromBase64String(signatureFromDb);

            return rsa.VerifyData(bytesToVerify, signatureBytes, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
        }
    }
}